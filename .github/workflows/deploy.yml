name: Deploy Contracts

on:
  workflow_dispatch:
    inputs:
      network:
        description: "Target network"
        required: true
        default: "testnet"
        type: choice
        options:
          - testnet
          - mainnet

jobs:
  deploy-testnet:
    if: github.event.inputs.network == 'testnet'
    runs-on: ubuntu-latest
    environment: testnet

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Compile contracts
        run: npm run compile

      - name: Run tests
        run: npm test

      - name: Deploy to Testnet
        env:
          DEPLOYER_PRIVATE_KEY: ${{ secrets.TESTNET_DEPLOYER_KEY }}
          FEE_RECIPIENT: ${{ secrets.TESTNET_TREASURY }}
          ADMIN_ADDRESS: ${{ secrets.TESTNET_ADMIN }}
          PROTOCOL_FEE_BPS: "100"
        run: npm run deploy:testnet

      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v4
        with:
          name: testnet-deployment
          path: deployments/testnet.json

  deploy-mainnet:
    if: github.event.inputs.network == 'mainnet'
    runs-on: ubuntu-latest
    environment: mainnet # Requires manual approval

    steps:
      - uses: actions/checkout@v4

      - name: Verify audit tag
        run: |
          if ! git tag -l | grep -q "audit-approved"; then
            echo "ERROR: Mainnet deploy requires audit-approved tag"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Compile contracts
        run: npm run compile

      - name: Run tests
        run: npm test

      - name: Deploy to Mainnet
        env:
          DEPLOYER_PRIVATE_KEY: ${{ secrets.MAINNET_DEPLOYER_KEY }}
          FEE_RECIPIENT: ${{ secrets.MAINNET_TREASURY }}
          ADMIN_ADDRESS: ${{ secrets.MAINNET_ADMIN }}
          PROTOCOL_FEE_BPS: "100"
        run: npm run deploy:mainnet

      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mainnet-deployment
          path: deployments/mainnet.json
